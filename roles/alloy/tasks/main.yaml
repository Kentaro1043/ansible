---
- name: Import alloy GPG key
  become: true
  ansible.builtin.apt_key:
    url: https://apt.grafana.com/gpg.key
    state: present

- name: Add alloy repository
  become: true
  notify: Update apt cache
  ansible.builtin.apt_repository:
    repo: "deb https://apt.grafana.com stable main"
    state: present

- name: Install alloy
  become: true
  ansible.builtin.apt:
    name: alloy
    state: present

- name: Add alloy user to docker group
  become: true
  ansible.builtin.user:
    name: alloy
    groups: docker
    append: true

- name: Change user using alloy service
  become: true
  notify:
    - Reload systemd
    - Restart alloy
  ansible.builtin.replace:
    path: /etc/systemd/system/alloy.service
    regexp: "^User=alloy$"
    replace: "User=root"

- name: Make alloy config directory
  become: true
  ansible.builtin.file:
    path: /etc/alloy
    state: directory
    mode: '0755'

- name: Copy alloy config
  become: true
  notify:
    - Reload systemd
    - Restart alloy
  ansible.builtin.template:
    src: config.alloy.j2
    dest: /etc/alloy/config.alloy
    mode: '0644'

- name: Start alloy
  become: true
  ansible.builtin.systemd:
    name: alloy
    state: started
    enabled: true
